# Real estate listing website example from Valve: Securing Function Workflows on Serverless Computing Platforms

id: refund
name: Refund example
version: '0.1.0'
specVersion: '0.8'
start: entry-event

events:
  - name: triggerEvent
    type: http.request.received
    source: entry-point
    kind: consumed
  - name: getOrder
    type: order.database.get
    kind: produced
  - name: resultOrder
    type: order.database.result
    source: database-dummy
    kind: consumed
  - name: emitRefund
    type: info.database.emitRefund
    kind: produced
  - name: resultRefund
    type: info.database.result
    source: database-dummy
    kind: consumed

functions:
  - name: process-event
    type: expression
    operation: |
      {
        transformed: (
          (
            .headers
            | to_entries
            | map(select(.key | ascii_downcase != "host"))
            | map({("HEADER_" + .key): .value})
            | add
          ) + .data
        )
      }
  - name: f1
    type: custom
    operation: knative:services.v1.serving.knative.dev/f1?method=POST
  - name: f2
    type: custom
    operation: knative:services.v1.serving.knative.dev/f2?method=POST
  - name: f3
    type: custom
    operation: knative:services.v1.serving.knative.dev/f3?method=POST
  - name: f4
    type: custom
    operation: knative:services.v1.serving.knative.dev/f4?method=POST
  - name: result
    type: custom
    operation: knative:services.v1.serving.knative.dev/result?method=POST

states:
  - name: entry-event
    type: event
    onEvents:
      - eventRefs:
          - triggerEvent
        actions:
        - functionRef: process-event
    stateDataFilter:
      output: "${ .transformed }"
    transition: f1-authentication
  
  - name: f1-authentication
    type: operation
    actions: 
      - functionRef: f1
        actionDataFilter:
          toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: d1-orders

  - name: d1-orders
    type: callback
    action:
      eventRef:
        triggerEventRef: getOrder
        resultEventRef: resultOrder         # this is ignored in Sonataflow
    eventRef: resultOrder
    eventDataFilter:
      data: "${ .data }"
      toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: f2-validation

  - name: f2-validation
    type: operation
    actions: 
      - functionRef: f2
        actionDataFilter:
          toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: f3-calculate-refund

  - name: f3-calculate-refund
    type: operation
    actions: 
      - functionRef: f3
        actionDataFilter:
          toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: d2-refund

  - name: d2-refund
    type: callback
    action:
      eventRef:
        triggerEventRef: emitRefund
        resultEventRef: resultRefund         # this is ignored in Sonataflow
    eventRef: resultRefund
    eventDataFilter:
      data: "${ .data }"
      toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: f4-issue-refund

  - name: f4-issue-refund
    type: operation
    actions:
      - functionRef: f4
        actionDataFilter:
          toStateData: ._result
    stateDataFilter:
      output: ._result
    transition: result

  - name: result
    type: operation
    actions:
      - functionRef:
          refName: result
    end: true
